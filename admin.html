<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FlipTrybe Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; padding: 20px; background: #f3f4f6; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .badge { padding: 5px 10px; border-radius: 15px; font-weight: bold; font-size: 12px; }
        .AVAILABLE { background: #d1fae5; color: #065f46; }
        .BUSY { background: #fee2e2; color: #991b1b; }
        .error-box { background: #fee2e2; color: #991b1b; padding: 10px; border-radius: 5px; display: none; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="errorDisplay" class="error-box"></div>

    <div class="card">
        <h2>üéõÔ∏è System Control</h2>
        <p>Current Mode: <strong id="modeText">---</strong></p>
        <button onclick="toggleMode()">Switch Payment Mode</button>
        <button onclick="resetSystem()" style="background:red; color:white; border:none; padding:10px; float:right;">‚ö†Ô∏è RESET DRIVERS</button>
    </div>

    <div class="card">
        <h2>üöõ Driver Fleet</h2>
        <table width="100%">
            <thead><th align="left">Name</th><th align="left">Vehicle</th><th>Status</th></thead>
            <tbody id="driverTable"></tbody>
        </table>
    </div>

    <script>
        // Check if user opened file directly
        if (window.location.protocol === 'file:') {
            alert("‚ùå STOP! You cannot open this file directly.\nPlease open: http://127.0.0.1:8000/admin-panel");
        }

        async function loadData() {
            try {
                const res = await fetch('/api/admin/status');
                if (!res.ok) throw new Error(`Server Error: ${res.status}`);
                
                const data = await res.json();
                
                // Hide error if successful
                document.getElementById('errorDisplay').style.display = 'none';

                // Update Mode
                const modeEl = document.getElementById('modeText');
                modeEl.innerText = data.mode;
                modeEl.style.color = data.mode === 'MANUAL' ? 'orange' : 'green';

                // Update Table
                const table = document.getElementById('driverTable');
                table.innerHTML = '';
                data.drivers.forEach(d => {
                    table.innerHTML += `<tr>
                        <td>${d.name}</td>
                        <td>${d.vehicle_type}</td>
                        <td><span class="badge ${d.status}">${d.status}</span></td>
                    </tr>`;
                });
            } catch (err) {
                const errBox = document.getElementById('errorDisplay');
                errBox.style.display = 'block';
                errBox.innerText = "‚ö†Ô∏è CONNECTION ERROR: " + err.message + ". Is the server running?";
            }
        }

        async function toggleMode() { await fetch('/api/admin/toggle-mode', { method: 'POST' }); loadData(); }
        async function resetSystem() { await fetch('/api/admin/reset-drivers', { method: 'POST' }); loadData(); }

        setInterval(loadData, 3000);
        loadData();
    </script>
</body>
</html>
{% extends "base.html" %}
{% block content %}
<div class="bg-zinc-950 min-h-screen text-white pb-32 font-sans selection:bg-indigo-500/30">
    
    <div class="bg-zinc-900/90 backdrop-blur-xl sticky top-0 z-50 py-6 border-b border-white/5">
        <div class="max-w-7xl mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center gap-6">
                <div class="w-12 h-12 bg-indigo-600 rounded-2xl flex items-center justify-center shadow-lg shadow-indigo-500/30">
                    <i class="fas fa-shuttle-van text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black tracking-tight">{{ current_user.name }}</h1>
                    <div class="flex items-center gap-2">
                        <span id="gps-status" class="w-2 h-2 bg-rose-500 rounded-full"></span>
                        <p class="text-[8px] font-black text-zinc-400 uppercase tracking-widest" id="gps-text">GPS Beacon: Offline</p>
                    </div>
                </div>
            </div>

            <div class="hidden md:flex items-center gap-6 bg-white/5 px-6 py-3 rounded-2xl border border-white/10">
                <div class="text-right">
                    <p class="text-[8px] font-black text-zinc-500 uppercase tracking-widest mb-1">Bonus Progress ({{ current_user.handshake_count_weekly }}/10)</p>
                    
                    <div id="mini-velocity-meter" class="w-32 h-1 bg-zinc-800 rounded-full overflow-hidden" 
                         data-percent="{{ (current_user.handshake_count_weekly * 10) | default(0) }}">
                        <div id="mini-velocity-bar" class="h-full bg-emerald-500 transition-all duration-1000" style="width: 0%"></div>
                    </div>
                </div>
                <div class="w-px h-6 bg-white/10"></div>
                <div>
                    <p class="text-[8px] font-black text-zinc-500 uppercase tracking-widest mb-1">Earnings</p>
                    <p class="text-xs font-black text-emerald-400">â‚¦{{ "{:,.0f}".format(current_user.wallet_balance) }}</p>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-5xl mx-auto px-6 mt-16 space-y-20">
        
        <section>
            <h2 class="text-xs font-black text-zinc-500 uppercase tracking-[0.4em] mb-10 flex items-center gap-4">
                <span class="w-2 h-2 bg-emerald-500 rounded-full animate-ping"></span> Live Signal Lockdown
            </h2>
            
            {% for mission in active %}
            <div class="bg-zinc-900 border border-white/5 rounded-[3.5rem] p-10 mb-8 relative overflow-hidden group">
                <div class="grid md:grid-cols-12 gap-10 relative z-10">
                    <div class="md:col-span-7">
                        <span class="text-[9px] font-black text-indigo-400 bg-indigo-400/10 px-4 py-2 rounded-xl border border-indigo-400/20 uppercase tracking-widest">
                            {{ mission.handshake_id }}
                        </span>
                        <h3 class="text-4xl font-black tracking-tighter mt-6 mb-4 leading-tight">{{ mission.listing.title }}</h3>
                        
                        <div class="space-y-4 mb-10">
                            <p class="text-zinc-400 text-sm flex items-center gap-4">
                                <i class="fas fa-map-location-dot text-indigo-500"></i> 
                                <span>Pickup: <span class="text-white font-bold">{{ mission.listing.city }}, {{ mission.listing.state }}</span></span>
                            </p>
                            <p class="text-zinc-400 text-sm flex items-center gap-4">
                                <i class="fas fa-user-tag text-indigo-500"></i> 
                                <span>Buyer: <span class="text-white font-bold">{{ mission.buyer.name }}</span></span>
                            </p>
                        </div>
                        
                        <div class="flex gap-4">
                            <a href="tel:{{ mission.buyer.phone }}" class="flex-1 py-5 bg-zinc-800 rounded-2xl text-[10px] font-black uppercase text-center hover:bg-white hover:text-black transition-all">Call Buyer</a>
                        </div>
                    </div>

                    <div class="md:col-span-5 bg-black rounded-[3rem] p-8 border border-white/5 shadow-2xl">
                        <p class="text-[9px] font-black text-zinc-500 uppercase tracking-[0.4em] text-center mb-8">Verification PIN</p>
                        <form action="{{ url_for('main.complete_task', order_id=mission.id) }}" method="POST" class="space-y-6">
                            <input type="text" name="pin" placeholder="0000" maxlength="4" required
                                   class="w-full bg-zinc-900 border-2 border-white/10 rounded-2xl py-6 text-center text-4xl font-black tracking-[0.5em] text-emerald-400 focus:border-emerald-500 focus:ring-0 transition-all outline-none">
                            <button type="submit" class="w-full py-6 bg-indigo-600 text-white rounded-2xl font-black text-xs uppercase tracking-[0.3em] hover:bg-emerald-600 transition-all">
                                Confirm Handshake
                            </button>
                        </form>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="py-24 text-center bg-zinc-900/30 rounded-[3rem] border border-dashed border-white/5">
                <p class="text-[10px] font-black text-zinc-600 uppercase tracking-[0.3em]">No Active Transmissions</p>
            </div>
            {% endfor %}
        </section>

        <section>
            <div class="flex items-center gap-4 mb-8">
                <h2 class="text-xs font-black text-zinc-500 uppercase tracking-[0.4em]">Signal Radar (Available Tasks)</h2>
                <div class="h-px flex-1 bg-white/5"></div>
            </div>
            
            <div class="grid gap-4">
                {% for task in radar %}
                <div class="bg-zinc-900 border border-white/5 p-8 rounded-[2.5rem] flex flex-col md:flex-row justify-between items-center gap-6 group hover:border-indigo-500/50 transition-all">
                    <div class="flex items-center gap-8">
                        <div class="w-16 h-16 bg-black rounded-2xl overflow-hidden border border-white/5">
                            <img src="{{ url_for('static', filename='uploads/' + task.listing.image_filename) }}" class="w-full h-full object-cover opacity-50 group-hover:opacity-100">
                        </div>
                        <div>
                            <p class="text-[9px] font-black text-indigo-400 uppercase tracking-widest mb-1">{{ task.handshake_id }}</p>
                            <h4 class="text-xl font-black text-white mb-1">{{ task.listing.title }}</h4>
                            <p class="text-[8px] font-bold text-zinc-500 uppercase tracking-widest">{{ task.listing.city }} Hub</p>
                        </div>
                    </div>
                    <form action="{{ url_for('main.accept_mission', order_id=task.id) }}" method="POST" class="w-full md:w-auto">
                        <button class="w-full md:w-auto px-10 py-4 bg-white text-black rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-indigo-600 hover:text-white transition-all">
                            Intercept Signal
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </section>
    </div>
</div>

<script>
    /**
     * ðŸ›°ï¸ HARDENED UI INITIALIZATION
     */
    document.addEventListener('DOMContentLoaded', () => {
        // Apply the mission progress width to clear CSS diagnostic errors
        const meter = document.getElementById('mini-velocity-meter');
        const bar = document.getElementById('mini-velocity-bar');
        if (meter && bar) {
            const percent = meter.getAttribute('data-percent');
            bar.style.width = percent + '%';
        }
    });

    /**
     * ðŸ›°ï¸ GPS BEACON TRANSMISSION
     */
    function transmitSignal() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(position => {
                const data = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    strength: Math.floor(Math.random() * (100 - 85 + 1)) + 85
                };
                
                fetch("{{ url_for('main.update_radar') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(() => {
                    const statusDot = document.getElementById('gps-status');
                    if(statusDot) {
                        statusDot.classList.replace('bg-rose-500', 'bg-emerald-500');
                        document.getElementById('gps-text').innerText = "GPS Beacon: Active Signal";
                    }
                });
            });
        }
    }

    if ("{{ active|length }}" > 0) {
        transmitSignal();
        setInterval(transmitSignal, 30000);
    }
</script>
{% endblock %}
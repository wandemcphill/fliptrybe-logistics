{% extends "base.html" %}
{% block content %}
<div class="max-w-7xl mx-auto py-12 px-6">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-6">
        <div>
            <h1 class="text-4xl font-black text-gray-900 tracking-tight">Agent Command Center</h1>
            <p class="text-gray-500 font-medium">Manage assets, location data, and live market intelligence.</p>
        </div>
        <div class="bg-black text-white p-6 rounded-[2.5rem] flex items-center gap-6 shadow-2xl">
            <div class="text-right">
                <p class="text-[10px] font-black uppercase text-gray-400 tracking-widest">Commission Wallet</p>
                <h2 class="text-2xl font-black text-green-400">‚Ç¶{{ "{:,.2f}".format(current_user.wallet_balance) }}</h2>
            </div>
            <div class="w-px h-10 bg-white/20"></div>
            <div class="text-right">
                <p class="text-[10px] font-black uppercase text-gray-400 tracking-widest">Active Listings</p>
                <h2 class="text-2xl font-black">{{ listings|length }}</h2>
            </div>
        </div>
    </div>

    <div class="grid lg:grid-cols-12 gap-10">
        
        <div class="lg:col-span-4">
            <div class="bg-white p-8 rounded-[3rem] shadow-xl border border-gray-100 sticky top-24">
                <h2 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <span class="w-3 h-3 bg-indigo-600 rounded-full animate-pulse"></span>
                    New Listing
                </h2>
                
                <form action="{{ url_for('main.upload_item') }}" method="POST" enctype="multipart/form-data" class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-1">Asset Title</label>
                        <input type="text" name="title" placeholder="e.g. Luxury 2-Bed Shortlet" required
                               class="w-full p-4 bg-gray-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-black outline-none transition">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-[10px] font-black uppercase text-gray-400 mb-1">State</label>
                            <select name="state" class="w-full p-4 bg-gray-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-black outline-none cursor-pointer appearance-none">
                                <option>Lagos</option>
                                <option>Abuja</option>
                                <option>PH</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-[10px] font-black uppercase text-gray-400 mb-1">City</label>
                            <input type="text" name="city" placeholder="Lekki" required
                                   class="w-full p-4 bg-gray-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-black outline-none transition">
                        </div>
                    </div>

                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-1">Category</label>
                        <select name="category" id="cat-select" onchange="updatePriceSuggestion()" 
                                class="w-full p-4 bg-gray-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-black outline-none cursor-pointer appearance-none">
                            <option value="Declutter">üì¶ Declutter Item</option>
                            <option value="Shortlet">üè† Shortlet Booking</option>
                            <option value="Gadgets">üì± Gadgets</option>
                            <option value="Fashion">üëü Fashion</option>
                            <option value="Vehicles">üöó Vehicles</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-1">Asking Price (‚Ç¶)</label>
                        <input type="number" name="price" id="price-input" oninput="updatePriceSuggestion()" placeholder="0" required
                               class="w-full p-4 bg-gray-50 border-none rounded-2xl text-sm focus:ring-2 focus:ring-black outline-none transition">
                        
                        <div id="suggestion-box" class="mt-4 p-4 rounded-2xl bg-indigo-50 border border-indigo-100 hidden transition-all duration-300">
                            <p id="suggestion-text" class="text-[11px] font-bold text-indigo-700 leading-snug"></p>
                        </div>
                    </div>

                    <div class="pt-2">
                        <label class="block text-[10px] font-black uppercase text-gray-400 mb-1">Photo</label>
                        <input type="file" name="image" accept="image/*"
                               class="w-full text-[10px] text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:font-black file:bg-gray-900 file:text-white hover:file:bg-gray-700 cursor-pointer">
                    </div>

                    <button type="submit" class="w-full bg-black text-white font-black py-5 rounded-2xl hover:bg-indigo-600 transition-all shadow-xl active:scale-95 mt-4">
                        Push to Marketplace
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-8">
            <h2 class="text-xl font-bold mb-6">Live Inventory</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                {% for listing in listings %}
                <div class="bg-white rounded-[2.5rem] border border-gray-100 overflow-hidden shadow-sm hover:shadow-xl transition-all duration-500 group">
                    <div class="relative h-48 overflow-hidden">
                        {% if listing.image_filename %}
                        <img src="{{ url_for('static', filename='uploads/' + listing.image_filename) }}" 
                             class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                        {% else %}
                        <div class="w-full h-full bg-gray-50 flex items-center justify-center text-gray-400 font-bold italic text-xs">No Image</div>
                        {% endif %}
                        <div class="absolute top-4 left-4">
                            <span class="bg-black text-white px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest">
                                {{ listing.category }}
                            </span>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-2">
                            <h3 class="font-bold text-gray-900 text-lg truncate pr-2">{{ listing.title }}</h3>
                            <p class="text-indigo-600 font-black whitespace-nowrap">‚Ç¶{{ "{:,.0f}".format(listing.price) }}</p>
                        </div>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-widest mb-4">üìç {{ listing.city }}, {{ listing.state }}</p>
                        
                        <div class="flex justify-between items-center pt-4 border-t border-gray-50">
                            <span class="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-gray-500">
                                <span class="w-2 h-2 rounded-full {% if listing.status == 'Available' %}bg-green-500{% else %}bg-red-500{% endif %}"></span>
                                {{ listing.status }}
                            </span>
                            
                            <form action="{{ url_for('main.delete_listing', listing_id=listing.id) }}" method="POST" onsubmit="return confirm('Permanently delete this listing?');">
                                <button type="submit" class="text-[10px] font-black uppercase text-gray-300 hover:text-red-500 transition">Remove</button>
                            </form>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="col-span-full py-24 text-center bg-gray-50 rounded-[3rem] border-2 border-dashed border-gray-100">
                    <p class="text-gray-400 font-bold text-sm">You haven't listed any items yet.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
function updatePriceSuggestion() {
    const category = document.getElementById('cat-select').value;
    const priceInput = document.getElementById('price-input').value;
    const suggestionBox = document.getElementById('suggestion-box');
    const suggestionText = document.getElementById('suggestion-text');

    // Pulling market intelligence from Flask safely
    const sAvg = Number("{{ s_avg | default(45000) }}");
    const dAvg = Number("{{ d_avg | default(15000) }}");
    // Simple logic: Shortlets use high avg, everything else uses low avg
    const currentAvg = (category === "Shortlet") ? sAvg : dAvg;

    if (priceInput > 0) {
        suggestionBox.classList.remove('hidden');
        const diff = ((priceInput - currentAvg) / currentAvg) * 100;
        
        let analysis = "";
        if (diff > 20) {
            analysis = `‚ö†Ô∏è <span class="text-orange-600">PREMIUM:</span> This is ${Math.abs(Math.round(diff))}% above market avg (‚Ç¶${currentAvg.toLocaleString()}).`;
        } else if (diff < -10) {
            analysis = `üöÄ <span class="text-green-600">FAST-SELLER:</span> Priced ${Math.abs(Math.round(diff))}% below average! High demand expected.`;
        } else {
            analysis = `‚úÖ <span class="text-indigo-600">OPTIMIZED:</span> You are perfectly aligned with the current market average of ‚Ç¶${currentAvg.toLocaleString()}.`;
        }
        
        suggestionText.innerHTML = analysis;
    } else {
        suggestionBox.classList.add('hidden');
    }
}

// Initial check on page load
document.addEventListener('DOMContentLoaded', updatePriceSuggestion);
</script>
{% endblock %}
{% extends "base.html" %}
{% block content %}
<div class="max-w-3xl mx-auto px-4 py-12 h-[calc(100vh-120px)] flex flex-col">
    
    <div class="bg-white/80 backdrop-blur-xl border border-gray-100 p-6 rounded-t-[2.5rem] flex items-center justify-between shadow-sm z-20">
        <div class="flex items-center gap-4">
            <a href="{{ url_for('main.inbox') }}" class="w-10 h-10 flex items-center justify-center rounded-full text-gray-400 hover:bg-gray-50 hover:text-black transition-all">
                <i class="fas fa-chevron-left text-sm"></i>
            </a>
            <div class="relative">
                <div class="w-12 h-12 rounded-2xl overflow-hidden bg-zinc-900 border border-white shadow-md">
                    {% if partner.image_file %}
                    <img src="{{ url_for('static', filename='uploads/' + partner.image_file) }}" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-indigo-500 to-purple-600 text-white font-black text-lg">
                        {{ partner.name[0] | upper }}
                    </div>
                    {% endif %}
                </div>
                <span class="absolute -bottom-1 -right-1 w-4 h-4 bg-emerald-500 border-4 border-white rounded-full"></span>
            </div>
            <div>
                <h2 class="font-black text-gray-900 leading-none mb-1">{{ partner.name }}</h2>
                <div class="flex items-center gap-2">
                    <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest">{{ partner.role }}</span>
                    <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                    <p class="text-[9px] text-emerald-500 font-bold uppercase tracking-widest">Signal Active</p>
                </div>
            </div>
        </div>
        
        <div class="hidden sm:flex items-center gap-2 px-4 py-2 bg-gray-50 rounded-xl border border-gray-100">
            <i class="fas fa-lock text-[10px] text-gray-400"></i>
            <span class="text-[9px] font-black text-gray-400 uppercase tracking-widest">Secure Link</span>
        </div>
    </div>

    <div class="flex-grow bg-white border-x border-gray-50 p-6 overflow-y-auto space-y-6 no-scrollbar" id="chat-container">
        <div class="flex justify-center mb-8">
            <span class="bg-gray-50 text-[9px] font-bold text-gray-400 px-4 py-1.5 rounded-full uppercase tracking-widest border border-gray-100">
                End-to-end encrypted transmission initiated
            </span>
        </div>

        {% for msg in messages %}
            {% if msg.sender_id == current_user.id %}
            <div class="flex flex-col items-end gap-1 group">
                <div class="bg-gradient-to-br from-indigo-600 to-violet-700 text-white px-6 py-4 rounded-[2rem] rounded-tr-sm max-w-[85%] sm:max-w-[70%] text-sm font-medium shadow-xl shadow-indigo-100 animate-in fade-in slide-in-from-right-4 duration-300">
                    {{ msg.body }}
                </div>
                <span class="text-[8px] font-bold text-gray-300 uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity mr-2">
                    Sent • {{ msg.timestamp.strftime('%H:%M') }}
                </span>
            </div>
            {% else %}
            <div class="flex flex-col items-start gap-1 group">
                <div class="bg-white border border-gray-100 text-gray-800 px-6 py-4 rounded-[2rem] rounded-tl-sm max-w-[85%] sm:max-w-[70%] text-sm font-medium shadow-sm animate-in fade-in slide-in-from-left-4 duration-300">
                    {{ msg.body }}
                </div>
                <span class="text-[8px] font-bold text-gray-300 uppercase tracking-widest opacity-0 group-hover:opacity-100 transition-opacity ml-2">
                    {{ partner.name }} • {{ msg.timestamp.strftime('%H:%M') }}
                </span>
            </div>
            {% endif %}
        {% endfor %}
    </div>

    <div class="bg-white border border-gray-100 p-6 rounded-b-[2.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.05)]">
        <form action="{{ url_for('main.chat', user_id=partner.id) }}" method="POST" class="flex gap-4 items-center">
            <div class="flex-grow relative group">
                <input type="text" name="message" placeholder="Initialize message..." required autocomplete="off" autofocus
                       class="w-full bg-gray-50 border border-gray-100 rounded-2xl px-6 py-4 text-sm font-medium placeholder:text-gray-400 focus:ring-4 focus:ring-indigo-500/10 focus:bg-white focus:border-indigo-200 outline-none transition-all duration-300">
                <div class="absolute right-4 top-1/2 -translate-y-1/2 flex items-center gap-3 text-gray-300">
                    <i class="fas fa-paperclip hover:text-indigo-500 cursor-pointer transition"></i>
                    <i class="far fa-face-smile hover:text-indigo-500 cursor-pointer transition"></i>
                </div>
            </div>
            <button class="bg-zinc-900 text-white w-14 h-14 rounded-2xl flex items-center justify-center hover:bg-indigo-600 hover:shadow-2xl hover:shadow-indigo-200 transition-all duration-500 active:scale-90 group">
                <i class="fas fa-paper-plane text-sm group-hover:rotate-12 transition-transform"></i>
            </button>
        </form>
    </div>

</div>

<script>
    /**
     * Silicon Valley UX Logic:
     * 1. Auto-scrolls to the absolute bottom of the transmission history.
     * 2. Adds a slight delay to ensure all DOM elements are rendered.
     */
    function syncTerminal() {
        const container = document.getElementById('chat-container');
        container.scrollTo({
            top: container.scrollHeight,
            behavior: 'smooth'
        });
    }

    window.onload = syncTerminal;
    
    // Auto-scroll on new message input to maintain visibility
    document.querySelector('form').addEventListener('submit', () => {
        setTimeout(syncTerminal, 50);
    });
</script>
{% endblock %}
{% extends "base.html" %}
{% block content %}
<div class="max-w-6xl mx-auto px-6 py-20">
    <div class="grid lg:grid-cols-3 gap-16">
        
        <div class="lg:col-span-1">
            <div class="bg-zinc-900 text-white p-10 rounded-[3.5rem] shadow-2xl relative overflow-hidden">
                <p class="text-[9px] font-black text-zinc-500 uppercase tracking-widest mb-3">Available Liquidity</p>
                <h2 class="text-5xl font-black tracking-tighter" id="balance-display">₦{{ "{:,.2f}".format(current_user.wallet_balance) }}</h2>
                
                <form action="{{ url_for('main.request_withdrawal') }}" method="POST" class="mt-12 space-y-4">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="space-y-3">
                        <input type="number" name="amount" placeholder="Amount (₦)" class="w-full bg-zinc-800 border-none rounded-2xl px-6 py-4 text-white font-bold outline-none focus:ring-2 focus:ring-indigo-500 transition-all" required>
                        <input type="text" name="bank_name" placeholder="Bank Name" class="w-full bg-zinc-800 border-none rounded-2xl px-6 py-4 text-white font-bold outline-none" required>
                        <input type="text" name="account_number" placeholder="Account Number" class="w-full bg-zinc-800 border-none rounded-2xl px-6 py-4 text-white font-bold outline-none" required>
                    </div>
                    <button class="w-full py-5 bg-indigo-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-white hover:text-black transition-all duration-500 shadow-xl">
                        Initialize Off-Ramp
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-2">
            <div class="flex items-center justify-between mb-10">
                <h2 class="text-3xl font-black tracking-tighter">Asset Portfolio</h2>
                <a href="{{ url_for('main.new_listing') }}" class="px-6 py-3 bg-white border border-gray-100 rounded-xl text-[9px] font-black uppercase tracking-widest hover:bg-black hover:text-white transition-all">Transmit New Asset</a>
            </div>
            <div class="grid gap-6">
                {% for item in listings %}
                <div class="bg-white border border-gray-100 p-8 rounded-[2.5rem] flex items-center justify-between shadow-sm hover:shadow-xl transition-all">
                    <div class="flex items-center gap-6">
                        <div class="w-20 h-20 rounded-2xl bg-gray-50 overflow-hidden">
                            <img src="{{ url_for('static', filename='uploads/' + item.image_filename) }}" class="w-full h-full object-cover">
                        </div>
                        <div>
                            <h4 class="font-black text-gray-900">{{ item.title }}</h4>
                            <p class="text-[10px] {% if item.status == 'Available' %}text-emerald-500{% else %}text-indigo-500{% endif %} font-bold uppercase tracking-widest">{{ item.status }}</p>
                        </div>
                    </div>
                    <p class="text-xl font-black text-gray-900">₦{{ "{:,.0f}".format(item.price) }}</p>
                </div>
                {% else %}
                <div class="py-20 text-center bg-gray-50 rounded-[3rem] border border-dashed border-gray-200">
                    <p class="text-gray-400 font-bold uppercase text-[10px]">No active transmissions detected.</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
    function rollBalance(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = "₦" + (progress * (end - start) + start).toLocaleString(undefined, {minimumFractionDigits: 2});
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    setInterval(async () => {
        try {
            const res = await fetch('/api/balance-signal');
            const data = await res.json();
            const el = document.getElementById('balance-display');
            const current = parseFloat(el.innerText.replace('₦', '').replace(/,/g, ''));
            if (data.wallet_balance != current) {
                rollBalance(el, current, data.wallet_balance, 2000);
            }
        } catch (e) { console.log("Sync error"); }
    }, 10000);
</script>
{% endblock %}